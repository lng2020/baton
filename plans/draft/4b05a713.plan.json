{
  "id": "4b05a713",
  "title": "Add image upload support to both plan mode (chat) and task mode, storing images ",
  "summary": "Add image upload support to both plan mode (chat) and task mode, storing images on disk and passing them through to Claude Code",
  "content": "{\"plan\":true,\"summary\":\"Add image upload support to both plan mode (chat) and task mode, storing images on disk and passing them through to Claude Code\",\"tasks\":[{\"title\":\"Add image storage backend and static file serving\",\"content\":\"Create the image upload storage infrastructure:\\n\\n1. **Create uploads directory structure**: Add `uploads/` directory under the project root, organized by context (e.g., `uploads/chat/`, `uploads/tasks/`).\\n\\n2. **Add upload endpoint to agent** (`backend/agent.py`):\\n   - Add `from fastapi import UploadFile, File` to imports\\n   - Create `POST /agent/upload` endpoint that accepts multipart file uploads\\n   - Validate file types (allow only images: png, jpg, jpeg, gif, webp)\\n   - Limit file size (e.g., 10MB)\\n   - Save files to `uploads/{uuid_filename}.{ext}` preserving extension\\n   - Return JSON: `{\\\"filename\\\": \\\"...\\\", \\\"url\\\": \\\"/uploads/...\\\", \\\"original_name\\\": \\\"...\\\"}`\\n   - Mount `uploads/` as a static directory: `app.mount(\\\"/uploads\\\", StaticFiles(directory=uploads_dir), name=\\\"uploads\\\")`\\n\\n3. **Add upload proxy to dashboard** (`backend/server.py`):\\n   - Add `POST /api/projects/{project_id}/upload` endpoint\\n   - Accept `UploadFile` and forward it to the agent's `/agent/upload` endpoint via the connector\\n   - Mount a fallback static route if needed for serving uploads\\n\\n4. **Add upload method to connector layer**:\\n   - `backend/connectors/base.py`: Add `async def upload_image(self, file_data: bytes, filename: str) -> dict` abstract method\\n   - `backend/connectors/http.py`: Implement by POSTing multipart to `/agent/upload`\\n   - `backend/connectors/local.py`: Implement by saving directly to disk\\n\\n5. **Add `python-multipart` dependency** if not already installed (required by FastAPI for file uploads). Check `setup.py` or `pyproject.toml` and add it.\"},{\"title\":\"Add image upload UI to plan mode (chat)\",\"content\":\"Add image attachment capability to the chat/plan mode interface:\\n\\n1. **Update HTML** (`frontend/index.html`):\\n   - Add a file input and attachment button next to the chat textarea in `.chat-input-area` (line 53-56). Add before the send button:\\n   ```html\\n   <input type=\\\"file\\\" id=\\\"chat-image-input\\\" accept=\\\"image/*\\\" multiple style=\\\"display:none\\\" />\\n   <button class=\\\"btn-attach\\\" id=\\\"btn-chat-attach\\\" title=\\\"Attach image\\\">&#128206;</button>\\n   ```\\n   - Add an image preview area above the input area inside `chat-body`, just before `chat-input-area`:\\n   ```html\\n   <div class=\\\"chat-attachments\\\" id=\\\"chat-attachments\\\" style=\\\"display:none\\\"></div>\\n   ```\\n\\n2. **Update JavaScript** (`frontend/js/app.js`):\\n   - Add DOM refs for `chat-image-input`, `btn-chat-attach`, `chat-attachments`\\n   - Add state: `let chatPendingImages = []` (array of `{file, previewUrl, uploadedUrl, uploadedFilename}`)\\n   - Wire `btn-chat-attach` click to trigger `chat-image-input.click()`\\n   - On `chat-image-input` change: for each selected file, create an object URL preview, push to `chatPendingImages`, render preview thumbnails with remove buttons in `#chat-attachments`\\n   - Modify `sendMessage()` function:\\n     a. Before sending the chat request, upload each pending image via `POST /api/projects/{projectId}/upload` using `FormData`\\n     b. Collect the returned URLs/filenames\\n     c. Append image references to the message content (e.g., `\\\\n\\\\n[Attached image: /uploads/filename.png]` for each image)\\n     d. Include the image paths in the chat payload so the backend can pass them to Claude\\n     e. Clear `chatPendingImages` and hide the preview area after sending\\n   - In `appendMessage()`: if message contains image references, render them as `<img>` tags in the chat bubble\\n   - Update `saveChatState()`/`restoreChatState()` to include `chatPendingImages`\\n   - Update `resetChat()` to clear pending images\\n\\n3. **Update CSS** (`frontend/css/style.css`):\\n   - Style `.btn-attach` similar to `.btn-send` but with a muted color\\n   - Style `.chat-attachments` as a horizontal flex row of thumbnail previews (e.g., 60x60px thumbnails with rounded corners)\\n   - Style remove button on each thumbnail (small X in corner)\\n   - Style `img` tags inside `.chat-bubble` (max-width: 100%, border-radius, cursor pointer)\"},{\"title\":\"Add image upload UI to task mode\",\"content\":\"Add image attachment capability to the task creation form:\\n\\n1. **Update HTML** (`frontend/index.html`):\\n   - Add a file input and drop zone to the task form (inside `.task-form-body`, between the textarea and submit button, around line 69-70):\\n   ```html\\n   <div class=\\\"task-attachments-area\\\">\\n       <input type=\\\"file\\\" id=\\\"task-image-input\\\" accept=\\\"image/*\\\" multiple style=\\\"display:none\\\" />\\n       <button type=\\\"button\\\" class=\\\"btn-attach-task\\\" id=\\\"btn-task-attach\\\">Attach Images</button>\\n       <div class=\\\"task-attachments\\\" id=\\\"task-attachments\\\"></div>\\n   </div>\\n   ```\\n\\n2. **Update JavaScript** (`frontend/js/app.js`):\\n   - Add DOM refs for `task-image-input`, `btn-task-attach`, `task-attachments`\\n   - Add state: `let taskPendingImages = []`\\n   - Wire `btn-task-attach` click to trigger `task-image-input.click()`\\n   - On `task-image-input` change: create preview thumbnails with remove buttons in `#task-attachments`\\n   - Modify `submitTask()` function:\\n     a. Upload each pending image via `POST /api/projects/{projectId}/upload` using `FormData`\\n     b. Append image references to the task content (e.g., `\\\\n\\\\n## Attached Images\\\\n![image](/uploads/filename.png)` for each)\\n     c. Clear `taskPendingImages` and thumbnails after successful submission\\n\\n3. **Update CSS** (`frontend/css/style.css`):\\n   - Style `.btn-attach-task` as a dashed-border area or button matching the dark theme\\n   - Style `.task-attachments` as a flex row of thumbnails similar to chat attachments\\n   - Style `.task-attachments-area` with appropriate spacing\\n\\n4. **Update task detail rendering** in `renderDetail()` function (`frontend/js/app.js`):\\n   - When rendering task content, detect markdown image syntax `![...](/uploads/...)` and render as actual `<img>` tags\\n   - Or render the full content section using a simple markdown-to-HTML converter for images\"},{\"title\":\"Pass images to Claude Code in chat and dispatcher\",\"content\":\"Ensure uploaded images are passed through to Claude Code CLI so the AI can actually see them:\\n\\n1. **Update chat models** (`backend/models.py`):\\n   - Add optional `images` field to `ChatMessage`: `images: list[str] = []` (list of file paths relative to project root)\\n   - Add optional `images` field to `ChatRequest` messages\\n\\n2. **Update chat stream** (`backend/chat.py`):\\n   - Modify `chat_stream()` to accept image paths from messages\\n   - When building the stdin input for Claude Code, if images are present, include them. Claude Code CLI supports image input â€” check if it supports `--image` flag or if images need to be referenced in the prompt text.\\n   - The Claude Code CLI (`claude -p`) can accept images via the `--file` flag or by referencing local file paths. Update `_build_chat_command()` to add `--file /path/to/image` for each attached image, or include image paths in the prompt text so Claude Code's Read tool can view them.\\n   - Alternative approach: Since Claude Code has access to the filesystem, simply reference the image paths in the prompt text (e.g., \\\"See attached image at: /absolute/path/to/uploads/image.png\\\") and Claude Code will use its Read tool to view the image.\\n\\n3. **Update dispatcher task execution** (`backend/agent.py`, `_execute_task` method around line 644):\\n   - When building the prompt (line 662-669), parse the task markdown content for image references\\n   - Copy referenced images from `uploads/` to the worktree so Claude Code can access them\\n   - Or reference them by absolute path in the prompt\\n\\n4. **Update frontend chat payload** (`frontend/js/app.js`):\\n   - In `sendMessage()`, include the uploaded image filenames in the message payload so the backend knows which images to pass to Claude\\n   - Update the chat message format to include `images` array alongside `content`\"}]}",
  "status": "draft",
  "created": "2026-02-19T04:13:48.547555+00:00",
  "modified": "2026-02-19T04:13:48.547555+00:00",
  "tasks": [],
  "error": null
}